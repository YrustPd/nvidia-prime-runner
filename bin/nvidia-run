#!/usr/bin/env bash
set -euo pipefail

VERSION="1.0.0"
PROG_NAME="${0##*/}"

verbose=0
dry_run=0
no_banner=0

print_usage() {
  cat <<'USAGE'
Usage:
  nvidia-run [--verbose] [--dry-run] [--no-banner] [command|file] [args...]
  nvidia-run run <command|file> [args...]
  nvidia-run shell
  nvidia-run verify
  nvidia-run help | --help
  nvidia-run version | --version

Description:
  Run a single command or file with PRIME offload environment variables.
  With no arguments, starts an interactive shell configured for PRIME offload.

Flags:
  --verbose     Print env vars and the command before executing
  --dry-run     Print what would run and exit
  --no-banner   Shell mode only; sets NVIDIA_NO_BANNER=1

Examples:
  nvidia-run firefox-esr
  nvidia-run ./app.AppImage
  nvidia-run run /path/to/app --flag
  nvidia-run shell
  nvidia-run verify
USAGE
}

print_version() {
  printf '%s\n' "${PROG_NAME} version ${VERSION}"
}

print_verify() {
  cat <<'VERIFY'
Verify PRIME offload (run manually):
  glxinfo -B | grep renderer
  glxgears -info | grep -E "GL_RENDERER|GL_VENDOR|GL_VERSION"
  echo $DRI_PRIME
  lsof /dev/dri/renderD128 | grep <process>
VERIFY
}

print_error() {
  printf 'Error: %s\n' "$*" >&2
}

print_info() {
  printf '%s\n' "$*"
}

print_usage_hint() {
  printf 'Try: %s --help\n' "$PROG_NAME" >&2
}

print_cmd() {
  local -a cmd=("$@")
  printf '%q ' "${cmd[@]}"
  printf '\n'
}

print_env_list() {
  local label="$1"
  shift
  local -a env_list=("$@")
  printf '%s %s\n' "$label" "${env_list[*]}"
}

offload_env() {
  export DRI_PRIME=1
  export __NV_PRIME_RENDER_OFFLOAD=1
  export __GLX_VENDOR_LIBRARY_NAME=nvidia
}

run_exec() {
  local -a cmd=("$@")
  local -a env_list=(
    "DRI_PRIME=1"
    "__NV_PRIME_RENDER_OFFLOAD=1"
    "__GLX_VENDOR_LIBRARY_NAME=nvidia"
  )

  if (( verbose )); then
    print_env_list "Env:" "${env_list[@]}"
    print_info "Exec:"
    print_cmd "${cmd[@]}"
  fi

  if (( dry_run )); then
    print_info "Dry run: would execute:"
    print_cmd "${cmd[@]}"
    return 0
  fi

  offload_env
  exec "${cmd[@]}"
}

run_target() {
  local target="$1"
  shift
  local -a rest=("$@")

  if [[ -e "$target" ]]; then
    if [[ -d "$target" ]]; then
      print_error "Path is a directory: ${target}"
      exit 2
    fi

    if [[ "$target" == *.AppImage ]]; then
      if (( dry_run )); then
        print_info "Dry run: would chmod +x: ${target}"
      else
        if [[ ! -x "$target" ]]; then
          chmod +x -- "$target"
        fi
      fi
      run_exec "$target" "${rest[@]}"
      return 0
    fi

    if [[ -x "$target" ]]; then
      run_exec "$target" "${rest[@]}"
      return 0
    fi

    run_exec bash -- "$target" "${rest[@]}"
    return 0
  fi

  if [[ "$target" == */* ]]; then
    print_error "File not found: ${target}"
    exit 2
  fi

  if ! command -v -- "$target" >/dev/null 2>&1; then
    print_error "Command not found: ${target}"
    print_usage_hint
    exit 127
  fi

  run_exec "$target" "${rest[@]}"
}

start_shell() {
  local shell_path="${SHELL:-/bin/bash}"
  local -a shell_cmd=("$shell_path" "-i")
  local -a env_list=(
    "DRI_PRIME=1"
    "__NV_PRIME_RENDER_OFFLOAD=1"
    "__GLX_VENDOR_LIBRARY_NAME=nvidia"
    "NVIDIA_SHELL=1"
  )

  if (( no_banner )); then
    env_list+=("NVIDIA_NO_BANNER=1")
  fi

  if (( verbose )); then
    print_env_list "Env:" "${env_list[@]}"
    print_info "Exec:"
    print_cmd "${shell_cmd[@]}"
  fi

  if (( dry_run )); then
    print_info "Dry run: would execute:"
    print_cmd "${shell_cmd[@]}"
    return 0
  fi

  offload_env
  export NVIDIA_SHELL=1
  if (( no_banner )); then
    export NVIDIA_NO_BANNER=1
  fi
  exec "${shell_cmd[@]}"
}

if [[ $# -eq 0 ]]; then
  start_shell
  exit 0
fi

positional=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --help|-h)
      print_usage
      exit 0
      ;;
    --version)
      print_version
      exit 0
      ;;
    --verbose)
      verbose=1
      shift
      ;;
    --dry-run)
      dry_run=1
      shift
      ;;
    --no-banner)
      no_banner=1
      shift
      ;;
    --)
      shift
      while [[ $# -gt 0 ]]; do
        positional+=("$1")
        shift
      done
      ;;
    *)
      positional+=("$1")
      shift
      ;;
  esac
 done

if [[ ${#positional[@]} -eq 0 ]]; then
  start_shell
  exit 0
fi

subcommand="${positional[0]}"
case "$subcommand" in
  help)
    print_usage
    exit 0
    ;;
  version)
    print_version
    exit 0
    ;;
  shell)
    if [[ ${#positional[@]} -gt 1 ]]; then
      print_error "'shell' does not take extra arguments"
      exit 2
    fi
    start_shell
    ;;
  verify)
    if [[ ${#positional[@]} -gt 1 ]]; then
      print_error "'verify' does not take extra arguments"
      exit 2
    fi
    print_verify
    ;;
  run)
    if [[ ${#positional[@]} -lt 2 ]]; then
      print_error "Missing command after 'run'"
      print_usage_hint
      exit 2
    fi
    run_target "${positional[1]}" "${positional[@]:2}"
    ;;
  *)
    if [[ "$subcommand" == -* ]]; then
      print_error "Unknown option: ${subcommand}"
      print_usage_hint
      exit 2
    fi
    run_target "${positional[0]}" "${positional[@]:1}"
    ;;
esac
